/*  backbone.fetch-cache v1.0.0 (2013-07-23)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,c){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return e.Backbone=c(_,Backbone)}):e.Backbone=c(e._,e.Backbone)})(this,function(_,Backbone){function e(e,c){var t;return(t=c&&c.url?c.url:_.isFunction(e.url)?e.url():e.url)?c&&c.data?t+"?"+$.param(c.data):t:void 0}function c(e,c,t){c=c||{};var h=Backbone.fetchCache.getCacheKey(e,c),a=!1;h&&c.cache!==!1&&(c.cache||c.prefill)&&(c.expires!==!1&&(a=(new Date).getTime()+1e3*(c.expires||300)),Backbone.fetchCache._cache[h]={expires:a,value:t},Backbone.fetchCache.setLocalStorage())}function t(e){delete Backbone.fetchCache._cache[e],Backbone.fetchCache.setLocalStorage()}function h(){if(o&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){var c=e.code||e.number||e.message;if(22!==c)throw e;this._deleteCacheWithPriority()}}function a(){if(o&&Backbone.fetchCache.localStorage){var e=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(e)}}function i(e){return window.setTimeout(e,0)}var r={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},o=window.localStorage!==void 0;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(e,c){return e&&e.expires&&c&&c.expires?e.expires-c.expires:e},Backbone.fetchCache._prioritize=function(){var e=_.values(this._cache).sort(this.priorityFn),c=_.indexOf(_.values(this._cache),e[0]);return _.keys(this._cache)[c]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(e){e=e||{};var c=Backbone.fetchCache.getCacheKey(this,e),t=Backbone.fetchCache._cache[c],h=!1,a=!1,o=new $.Deferred,n=this;return t&&(h=t.expires,h=h&&t.expires<(new Date).getTime(),a=t.value),h||!e.cache&&!e.prefill||!a||(i(function(){n.set(n.parse(a),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(n,a,e),n.trigger("cachesync",n,a,e),n.trigger("sync",n,a,e),e.prefill?o.notify(n):(_.isFunction(e.success)&&e.success(n),o.resolve(n))}),e.prefill)?(r.modelFetch.apply(this,arguments).done(_.bind(o.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(o.reject,this,this)),o.promise()):o.promise()},Backbone.Model.prototype.sync=function(e,c){if("read"===e)return r.modelSync.apply(this,arguments);var h,a,i=c.collection,o=[];for(o.push(Backbone.fetchCache.getCacheKey(c)),i&&o.push(Backbone.fetchCache.getCacheKey(i)),h=0,a=o.length;a>h;h++)t(o[h]);return r.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(e){e=e||{};var c=Backbone.fetchCache.getCacheKey(this,e),t=Backbone.fetchCache._cache[c],h=!1,a=!1,o=new $.Deferred,n=this;return t&&(h=t.expires,h=h&&t.expires<(new Date).getTime(),a=t.value),h||!e.cache&&!e.prefill||!a||(i(function(){n[e.reset?"reset":"set"](n.parse(a),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(n),n.trigger("cachesync",n,a,e),n.trigger("sync",n,a,e),e.prefill?o.notify(n):(_.isFunction(e.success)&&e.success(n),o.resolve(n))}),e.prefill)?(r.collectionFetch.apply(this,arguments).done(_.bind(o.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(o.reject,this,this)),o.promise()):o.promise()},a(),Backbone.fetchCache._superMethods=r,Backbone.fetchCache.setCache=c,Backbone.fetchCache.getCacheKey=e,Backbone.fetchCache.clearItem=t,Backbone.fetchCache.setLocalStorage=h,Backbone.fetchCache.getLocalStorage=a,Backbone});