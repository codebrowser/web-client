var config={apiRoot:"http://t-avihavai.users.cs.helsinki.fi/cb-back/app/",editor:{configure:function(a){a.setReadOnly(!0),a.setPrintMarginColumn(!1),a.setDisplayIndentGuides(!1),a.getSession().setFoldStyle("markbeginend"),a.setTheme("ace/theme/crimson_editor"),a.setFontSize(12),a.getSession().setTabSize(4),a.getSession().setUseWrapMode(!0),a.getSession().setWrapLimitRange(120,120)}}};$(document).ready(function(){codebrowser.initialize()});var codebrowser={app:{},helper:{},model:{},collection:{},view:{},router:{},initialize:function(){codebrowser.app.base=new codebrowser.router.BaseRouter,codebrowser.app.snapshot=new codebrowser.router.SnapshotRouter,Backbone.history.start()}};codebrowser.helper.AceModeMapper={mode:{java:"java"},getMode:function(a){var b="text";if(-1!==a.indexOf(".")&&0!==a.indexOf(".")){var c=a.split("."),d=c[c.length-1];b=this.mode[d]||b}return"ace/mode/"+b}},codebrowser.model.Course=Backbone.RelationalModel.extend({urlRoot:config.apiRoot+"courses",relations:[{type:Backbone.HasMany,key:"exercises",relatedModel:"codebrowser.model.Exercise",collectionType:"codebrowser.collection.ExerciseCollection",reverseRelation:{key:"course"}}]}),codebrowser.model.Exercise=Backbone.RelationalModel.extend({urlRoot:function(){return this.get("course").urlRoot+"/"+this.get("course").id+"/exercises"}}),codebrowser.model.File=Backbone.RelationalModel.extend({urlRoot:function(){return config.apiRoot+"students/"+this.get("snapshot").get("studentId")+"/courses/"+this.get("snapshot").get("courseId")+"/exercises/"+this.get("snapshot").get("exerciseId")+"/snapshots/"+this.get("snapshot").id+"/files"},fetchContent:function(a){var b=$.get(this.urlRoot()+"/"+this.id+"/content",function(b){a(b,null)});b.fail(function(){a(null,b)})}}),codebrowser.model.Snapshot=Backbone.RelationalModel.extend({urlRoot:function(){if(!this.get("studentId")||!this.get("courseId")||!this.get("exerciseId"))throw new Error("Attributes studentId, courseId and exerciseId are required to fetch a snapshot.");return config.apiRoot+"students/"+this.get("studentId")+"/courses/"+this.get("courseId")+"/exercises/"+this.get("exerciseId")+"/snapshots"},relations:[{type:Backbone.HasMany,key:"files",relatedModel:"codebrowser.model.File",collectionType:"codebrowser.collection.FileCollection",reverseRelation:{key:"snapshot"}}],convertTime:function(){if(this.get("snapshotTime")){var a=this.get("snapshotTime");this.set("snapshotTime",new Date(a).toLocaleString())}}}),codebrowser.model.Student=Backbone.RelationalModel.extend({urlRoot:config.apiRoot+"students",relations:[{type:Backbone.HasMany,key:"courses",relatedModel:"codebrowser.model.Course",collectionType:"codebrowser.collection.CourseCollection"}]}),codebrowser.collection.CourseCollection=Backbone.Collection.extend({model:codebrowser.model.Course,url:config.apiRoot+"courses"}),codebrowser.collection.ExerciseCollection=Backbone.Collection.extend({model:codebrowser.model.Exercise,url:function(){return this.course.urlRoot+"/"+this.course.id+"/exercises"}}),codebrowser.collection.FileCollection=Backbone.Collection.extend({model:codebrowser.model.File,url:function(){return config.apiRoot+"students/"+this.snapshot.get("studentId")+"/courses/"+this.snapshot.get("courseId")+"/exercises/"+this.snapshot.get("exerciseId")+"/snapshots/"+this.snapshot.id+"/files"}}),codebrowser.collection.SnapshotCollection=Backbone.Collection.extend({model:codebrowser.model.Snapshot,url:function(){if(!this.studentId||!this.courseId||!this.exerciseId)throw new Error("Options studentId, courseId and exerciseId are required to fetch snapshots.");return config.apiRoot+"students/"+this.studentId+"/courses/"+this.courseId+"/exercises/"+this.exerciseId+"/snapshots"},initialize:function(a,b){b&&(this.studentId=b.studentId,this.courseId=b.courseId,this.exerciseId=b.exerciseId)}}),codebrowser.collection.StudentCollection=Backbone.Collection.extend({model:codebrowser.model.Student,url:config.apiRoot+"students"}),codebrowser.view.EditorView=Backbone.View.extend({initialize:function(){this.render()},render:function(){var a=this;this.model.fetchContent(function(b){var c=a.model.get("name"),d=codebrowser.helper.AceModeMapper.getMode(c);a.setContent(b,d)});var b=Mustache.render($("#editor-template").html(),this.model.toJSON());$(this.el).html(b),this.editor=ace.edit("editor"),config.editor.configure(this.editor)},setContent:function(a,b){this.editor.setValue(a),this.editor.navigateFileStart(),this.editor.getSession().setMode(b)}}),codebrowser.view.SnapshotView=Backbone.View.extend({events:{"click #previous":"previous","click #next":"next"},initialize:function(){this.model=new codebrowser.model.Snapshot,this.render()},render:function(){var a=Mustache.render($("#snapshot-template").html(),this.model.toJSON());$(this.el).html(a)},setModel:function(a){this.model=a,this.model.convertTime(),this.configURLs(),this.render()},previous:function(a){var b=this.collection.indexOf(this.model),c=this.collection.at(b-1);this.navigate(c.id),a.preventDefault()},next:function(a){var b=this.collection.indexOf(this.model),c=this.collection.at(b+1);this.navigate(c.id),a.preventDefault()},navigate:function(a){codebrowser.app.snapshot.navigate("#/students/"+this.collection.studentId+"/courses/"+this.collection.courseId+"/exercises/"+this.collection.exerciseId+"/snapshots/"+a)},configURLs:function(){for(var a=0;a<this.model.get("files").length;++a){var b=this.model.get("files").at(a);b.set("url","#/students/"+this.collection.studentId+"/courses/"+this.collection.courseId+"/exercises/"+this.collection.exerciseId+"/snapshots/"+this.model.id+"/files/"+b.get("id"))}}}),codebrowser.router.BaseRouter=Backbone.Router.extend({routes:{"*notFound":"catch"},"catch":function(){$("#container").empty(),console.log("Catched!")}}),codebrowser.router.SnapshotRouter=Backbone.Router.extend({routes:{"students/:studentId/courses/:courseId/exercises/:exerciseId/snapshots/:id":"snapshot"},initialize:function(){this.snapshotView=new codebrowser.view.SnapshotView({el:$("#container")})},snapshot:function(a,b,c,d){var e=new codebrowser.collection.SnapshotCollection(null,{studentId:a,courseId:b,exerciseId:c});this.snapshotView.collection=e;var f=this;e.fetch({success:function(){var a=e.get(d);f.snapshotView.setModel(a),new codebrowser.view.EditorView({el:$("#editor-container"),model:a.get("files").at(0)})},error:function(){console.log("Request failed.")}})}});